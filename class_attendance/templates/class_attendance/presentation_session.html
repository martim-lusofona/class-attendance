{% extends "class_attendance/layout.html" %} {% load qr_code%} {%block content%}

<div class="container">
  <div class="row">
    <div class="col-sm d-flex flex-column justify-content-center">
      <img src="{% qr_url_from_text join_url %}" alt="join url QR code" />

      <div
        class="text-center fw-bold"
        style="font-size: 3rem; letter-spacing: 0.3rem"
        id="otp-token"
      >
        Loading...
      </div>

      <p class="text-center">Welcome to {{ session.school_class.label }}</p>

      <div class="progress mt-3">
        <div
          id="countdown-progress"
          class="progress-bar progress-bar-striped"
          role="progressbar"
          style="
            width: 100%;
            transition: width 1s ease-in-out, background-color 1s ease-in-out;
          "
          aria-valuenow="100"
          aria-valuemin="0"
          aria-valuemax="100"
        ></div>
      </div>
    </div>
    <div class="col-sm d-flex flex-column mt-5">
      <p class="text-center fw-bold fs-1">
        <span id="count-students">0</span> Students Joined
      </p>

      <ul
        id="students"
        class="list-group overflow-auto"
        style="max-height: 70vh"
      ></ul>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@otplib/preset-browser@^12.0.0/buffer.js"></script>
<script src="https://unpkg.com/@otplib/preset-browser@^12.0.0/index.js"></script>
<script>

  const secret = "{{ session.secret }}";
  const timeStep = {{ otp_interval }};
  otplib.authenticator.options = { step: timeStep };


  let animating = false;

  function animateOTP(finalToken) {
    animating = true;
    const display = document.getElementById('otp-token');
    const animationDuration = 1000;
    const frameInterval = 50;
    const totalFrames = Math.floor(animationDuration / frameInterval);
    let frame = 0;
    const intervalId = setInterval(() => {
      let randomToken = '';
      for (let i = 0; i < finalToken.length; i++) {
        randomToken += Math.floor(Math.random() * 10);
      }
      display.textContent = randomToken;
      frame++;
      if (frame >= totalFrames) {
        clearInterval(intervalId);
        display.textContent = finalToken;
        animating = false;
      }
    }, frameInterval);
  }


  function updateOTP() {
    const epoch = Math.floor(Date.now() / 1000);
    const remaining = timeStep - (epoch % timeStep);

    const token = otplib.authenticator.generate(secret);

    if (!animating) {
      if (remaining === timeStep) {
        animateOTP(token);
      } else {
        document.getElementById('otp-token').textContent = token;
      }
    }

    const progressBar = document.getElementById('countdown-progress');
    const progressPercent = (remaining / timeStep) * 100;
    progressBar.style.width = progressPercent + '%';
    progressBar.setAttribute('aria-valuenow', progressPercent);


    progressBar.classList.remove('bg-success', 'bg-warning', 'bg-danger');
    if (remaining > 6) {
      progressBar.classList.add('bg-success');
    } else if (remaining > 3) {
      progressBar.classList.add('bg-warning');
    } else {
      progressBar.classList.add('bg-danger');
    }
  }


  setInterval(updateOTP, 1000);
  updateOTP();

  function updateStudents() {
    const url = `/api/sessions/{{  session.uuid }}/students`;

    fetch(url)
      .then(response => response.json())
      .then(data => {
        const studentList = document.getElementById("students");
        studentList.innerHTML = "";
        data.students.forEach(student => {
            let li = document.createElement("li");
            li.classList.add("list-group-item");
            li.textContent = student;
            studentList.appendChild(li);

        });

        document.getElementById("count-students").textContent = data.students.length;
      })
      .catch(error => console.error("Error fetching students:", error));
  }

  setInterval(updateStudents, 5000);
  updateStudents();
</script>
{% endblock content %}
